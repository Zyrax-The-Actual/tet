<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zyrax Hub: 3D & Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #050505; color: white; height: 100vh; overflow: hidden; }
        
        /* Tab Navigation */
        nav { display: flex; background: #111; border-bottom: 2px solid #222; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #888; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { color: #0070f3; border-bottom: 2px solid #0070f3; background: #1a1a1a; }

        .content { height: calc(100vh - 52px); display: none; }
        .content.active { display: flex; }

        /* Chat Styles */
        #chat-section { flex-direction: column; background: #0a0a0a; }
        #log { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 70%; font-size: 14px; background: #222; align-self: flex-start; }
        .bubble.me { background: #0070f3; align-self: flex-end; }
        .input-bar { padding: 20px; display: flex; gap: 10px; background: #111; }
        input { background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; outline: none; }

        /* 3D Game Section */
        #game-section { position: relative; background: black; }
        #instructions { position: absolute; top: 10px; left: 10px; pointer-events: none; color: rgba(255,255,255,0.5); font-size: 12px; }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" onclick="openTab('chat-section', this)">CHAT</button>
    <button class="tab-btn" onclick="openTab('game-section', this)">3D ARENA</button>
</nav>

<div id="chat-section" class="content active">
    <div id="log"></div>
    <div class="input-bar">
        <input type="text" id="name" value="Zyrax" style="width: 80px;">
        <input type="text" id="msg" placeholder="Type a message..." style="flex: 1;">
        <button onclick="sendMsg()" style="padding: 0 20px; background: #0070f3; color: white; border: none; border-radius: 8px;">Send</button>
    </div>
</div>

<div id="game-section" class="content">
    <div id="instructions">WASD to Move | Syncing with Worker...</div>
</div>

<audio id="ping" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script>
    const API = "https://website-proxy-background.imcrabfr.workers.dev";
    const ping = document.getElementById('ping');

    // TAB LOGIC
    function openTab(id, btn) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    // CHAT LOGIC
    let lastCount = 0;
    async function sync() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            if (data.length > lastCount && lastCount !== 0) ping.play();
            lastCount = data.length;

            const me = document.getElementById('name').value;
            document.getElementById('log').innerHTML = data.map(m => `
                <div class="bubble ${m.user === me ? 'me' : ''}">
                    <small style="display:block;font-size:9px;opacity:0.6">${m.user}</small>${m.text}
                </div>
            `).join('');
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        } catch(e) {}
    }

    async function sendMsg() {
        const m = document.getElementById('msg');
        if(!m.value) return;
        ping.play();
        await fetch(API, { method: "POST", body: JSON.stringify({ user: document.getElementById('name').value, text: m.value }) });
        m.value = "";
        sync();
    }

    setInterval(sync, 2500);

    // --- 3D MULTIPLAYER ENGINE (THREE.JS) ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight - 52);
    document.getElementById('game-section').appendChild(renderer.domElement);

    // Lights & Floor
    const light = new THREE.PointLight(0xffffff, 500); light.position.set(10, 20, 10); scene.add(light);
    const grid = new THREE.GridHelper(100, 50, 0x444444, 0x222222); scene.add(grid);

    // My Player (Blue)
    const geo = new THREE.SphereGeometry(0.5);
    const matMe = new THREE.MeshStandardMaterial({ color: 0x0070f3 });
    const myPlayer = new THREE.Mesh(geo, matMe);
    scene.add(myPlayer);
    camera.position.set(0, 5, 10);
    camera.lookAt(myPlayer.position);

    // Movement
    const keys = {};
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function animate() {
        requestAnimationFrame(animate);
        if (keys['w']) myPlayer.position.z -= 0.1;
        if (keys['s']) myPlayer.position.z += 0.1;
        if (keys['a']) myPlayer.position.x -= 0.1;
        if (keys['d']) myPlayer.position.x += 0.1;

        camera.position.x = myPlayer.position.x;
        camera.position.z = myPlayer.position.z + 10;
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>